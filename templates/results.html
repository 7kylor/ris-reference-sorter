{% extends "base.html" %}

{% block title %}References â€” Reference Manager{% endblock %}

{% block nav_stats %}
<div class="nav-stats">
    <div class="nav-stat">
        <span class="nav-stat-value">{{ stats.unique_references }}</span>
        <span>total</span>
    </div>
    <div class="nav-stat">
        <span class="nav-stat-value">{{ stats.total_files }}</span>
        <span>files</span>
    </div>
    <div class="nav-stat">
        <span class="nav-stat-value">{{ stats.duplicates_removed }}</span>
        <span>duplicates</span>
    </div>
</div>
{% endblock %}

{% block nav_actions %}
<div class="nav-search">
    <input type="text" id="navSearchInput" placeholder="Search..." oninput="filterReferences()">
</div>
{% endblock %}

{% block content %}
<div style="width: 100%; margin: 0 auto;">
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-body" style="padding: 0.75rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <input type="url" id="urlInput" placeholder="Add URL (arXiv, DOI, or webpage)" style="flex: 1; min-width: 200px; margin: 0;">
                <button class="btn btn-primary" onclick="addUrl()">Add</button>
                <select id="citationStyleSelect" onchange="changeCitationStyle()" style="width: auto; min-width: 90px; margin: 0;">
                    <option value="apa" {% if citation_style == 'apa' %}selected{% endif %}>APA</option>
                    <option value="mla" {% if citation_style == 'mla' %}selected{% endif %}>MLA</option>
                    <option value="chicago" {% if citation_style == 'chicago' %}selected{% endif %}>Chicago</option>
                    <option value="harvard" {% if citation_style == 'harvard' %}selected{% endif %}>Harvard</option>
                    <option value="ieee" {% if citation_style == 'ieee' %}selected{% endif %}>IEEE</option>
                </select>
                <select id="exportFormat" style="width: auto; min-width: 90px; margin: 0;">
                    <option value="text">Text</option>
                    <option value="numbered">Numbered</option>
                    <option value="markdown">Markdown</option>
                    <option value="bibtex">BibTeX</option>
                    <option value="ris">RIS</option>
                </select>
                <button class="btn btn-sm btn-success" onclick="copyAll()">Copy</button>
                <button class="btn btn-sm btn-primary" onclick="download()">Download</button>
                <form action="{{ url_for('clear_references') }}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Clear all?')">Clear</button>
                </form>
            </div>
        </div>
    </div>

    {% if stats.operation_mode == 'merged' %}
    <div class="alert alert-success" style="margin-bottom: 1rem;">
        Added <strong>{{ stats.new_references_count }}</strong> new. Total: <strong>{{ stats.unique_references }}</strong>
    </div>
    {% endif %}

    <div id="referencesList">
        {% for reference in references %}
        <div class="reference-item" data-reference="{{ reference }}" data-index="{{ loop.index0 }}">
            <div class="reference-content">
                <span class="reference-number">{{ loop.index }}.</span>
                <span>{{ reference }}</span>
            </div>
            <div style="display: flex; gap: 0.375rem; flex-shrink: 0;">
                <button class="btn btn-sm btn-outline" onclick="copySingle(this)" title="Copy">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteSingle(this, {{ loop.index0 }})" title="Delete" style="color: var(--danger);">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div style="text-align: center; margin-top: 1.5rem; color: var(--text-light); font-size: 0.75rem;">
        Showing <span id="referenceCount">{{ references|length }}</span> of {{ references|length }}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const referenceData = {{ reference_data|tojson|safe if reference_data else '[]' }};
    const currentStyle = '{{ citation_style }}';
    const styleNames = { 'apa': 'APA', 'mla': 'MLA', 'chicago': 'Chicago', 'harvard': 'Harvard', 'ieee': 'IEEE' };

    function filterReferences() {
        const term = document.getElementById('navSearchInput')?.value.toLowerCase() || '';
        const items = document.querySelectorAll('.reference-item');
        let visible = 0;
        items.forEach(item => {
            const text = item.querySelector('.reference-content').textContent.toLowerCase();
            if (text.includes(term)) {
                item.style.display = 'flex';
                visible++;
            } else {
                item.style.display = 'none';
            }
        });
        document.getElementById('referenceCount').textContent = visible;
    }

    function changeCitationStyle() {
        const style = document.getElementById('citationStyleSelect').value;
        fetch('/api/change_style', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ style })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const list = document.getElementById('referencesList');
                list.innerHTML = '';
                data.references.forEach((ref, i) => {
                    const item = document.createElement('div');
                    item.className = 'reference-item';
                    item.setAttribute('data-reference', ref);
                    item.setAttribute('data-index', i);
                    item.innerHTML = `
                        <div class="reference-content">
                            <span class="reference-number">${i + 1}.</span>
                            <span>${ref}</span>
                        </div>
                        <div style="display: flex; gap: 0.375rem; flex-shrink: 0;">
                            <button class="btn btn-sm btn-outline" onclick="copySingle(this)" title="Copy">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deleteSingle(this, ${i})" title="Delete" style="color: var(--danger);">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                showToast(`Style: ${styleNames[style] || style.toUpperCase()}`);
            }
        })
        .catch(() => showToast('Error'));
    }

    function copySingle(btn) {
        const ref = btn.closest('.reference-item').querySelector('.reference-content').textContent.replace(/^\d+\.\s*/, '');
        copyToClipboard(ref);
    }

    function deleteSingle(btn, index) {
        if (!confirm('Delete this reference?')) return;
        
        fetch('/api/delete_reference', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                showToast('Error deleting');
            }
        })
        .catch(() => showToast('Error'));
    }

    function copyAll() {
        const format = document.getElementById('exportFormat').value;
        const style = document.getElementById('citationStyleSelect').value;
        fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reference_data: referenceData, format, style })
        })
        .then(r => r.json())
        .then(data => {
            copyToClipboard(data.exported_text);
            showToast('Copied');
        })
        .catch(() => showToast('Error'));
    }

    function download() {
        const format = document.getElementById('exportFormat').value;
        const style = document.getElementById('citationStyleSelect').value;
        fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reference_data: referenceData, format, style })
        })
        .then(r => r.json())
        .then(data => {
            const ext = { text: 'txt', numbered: 'txt', markdown: 'md', bibtex: 'bib', ris: 'ris' }[format] || 'txt';
            const blob = new Blob([data.exported_text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `references.${ext}`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Downloaded');
        })
        .catch(() => showToast('Error'));
    }

    function addUrl() {
        const urlInput = document.getElementById('urlInput');
        const url = urlInput.value.trim();
        const style = document.getElementById('citationStyleSelect').value;
        const addBtn = document.querySelector('.compact-form .btn-primary');

        if (!url) { showToast('Enter a URL'); return; }

        if (addBtn) { addBtn.disabled = true; addBtn.textContent = 'Fetching...'; }
        urlInput.disabled = true;

        fetch('/api/add_url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, style })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                urlInput.value = '';
                const meta = data.metadata || {};
                const title = (meta.title || 'Citation').substring(0, 40);
                showToast(`Added: ${title}${title.length >= 40 ? '...' : ''}`);
                setTimeout(() => window.location.reload(), 1200);
            } else {
                showToast('Error: ' + (data.error || 'Failed'));
                if (addBtn) { addBtn.disabled = false; addBtn.textContent = 'Add'; }
                urlInput.disabled = false;
            }
        })
        .catch(() => {
            showToast('Error fetching data');
            if (addBtn) { addBtn.disabled = false; addBtn.textContent = 'Add'; }
            urlInput.disabled = false;
        });
    }

    document.getElementById('urlInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addUrl(); }
    });
</script>
{% endblock %}
